name: Build & Release Static Binary (Glibc)

on:
  push:
    branches: [master]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

jobs:
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static (Glibc)
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 安装基础Rust工具链
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      # 安装系统依赖（移除upx-ucl，因为不再使用UPX）
      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends \
            build-essential \
            gh \
            libc6-dev  # 仅保留glibc静态库依赖，移除upx-ucl
          # 验证基础工具
          gcc --version
          gh --version
          echo "✅ 系统依赖安装成功"

      # Glibc静态编译（核心逻辑，无UPX）
      - name: Build Static Binary (Glibc)
        run: |
          set -euo pipefail
          BIN_NAME="srm"
          BIN_PATH="target/release/${BIN_NAME}"

          # Glibc静态编译的RUSTFLAGS
          RUSTFLAGS="\
            -C target-cpu=native \
            -C link-arg=-static \
            -C link-arg=-static-libgcc \
            -C link-arg=-static-libstdc++ \
            -C opt-level=3 \
            -C panic=abort \
            -C strip=symbols" \
          # 无需指定musl target，用默认的x86_64-unknown-linux-gnu
          cargo build --release -v

          # 验证产物
          ls -lh target/release/
          if [ ! -f "$BIN_PATH" ]; then
            echo "FATAL: 二进制文件未生成！"
            exit 1
          fi
          # 验证静态链接（Glibc静态编译的特征）
          file "$BIN_PATH" | grep -qi "statically linked" || {
            echo "WARNING: 未完全静态链接，但仍可运行（Glibc兼容）"
            file "$BIN_PATH"
          }
          echo "✅ Glibc静态编译成功（无UPX压缩）"

      # 验证二进制可运行（无段错误）
      - name: Verify Binary Runability
        run: |
          set -euo pipefail
          BIN_NAME="srm"
          BIN_PATH="target/release/${BIN_NAME}"

          chmod +x "$BIN_PATH"
          echo "=== 测试二进制基础功能 ==="
          if ! "$BIN_PATH" -h > /dev/null 2>&1; then
            echo "ERROR: 二进制运行失败！"
            "$BIN_PATH" -h 2>&1
            exit 1
          fi
          echo "✅ 二进制运行测试通过"

      # 打包（SRM命名）
      - name: Package (SRM Naming)
        id: package
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="srm"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            FINAL_BIN="srm-${VERSION}-linux-x86_64-static"
            # 直接复制原始二进制（无UPX压缩）
            cp target/release/${BIN_NAME} release/${FINAL_BIN}
            chmod +x release/${FINAL_BIN}
            # 生成校验和
            sha256sum release/${FINAL_BIN} | awk '{print $1 "  " $2}' > release/${FINAL_BIN}.sha256

            # 输出变量
            echo "final_bin=release/${FINAL_BIN}" >> $GITHUB_OUTPUT
            echo "final_sum=release/${FINAL_BIN}.sha256" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT

            # 打印结果
            echo "=== 最终产物（无UPX压缩）==="
            ls -lh release/
            cat release/${FINAL_BIN}.sha256
          else
            echo "Not a tag push, skip packaging"
          fi

      # 上传Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ startsWith(github.ref, 'refs/tags/') && format('srm-linux-x86_64-static-{0}', github.ref_name) || format('srm-linux-x86_64-static-dev-{0}', github.sha) }}
          path: release/
          retention-days: 30

      # 发布到GitHub Releases
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # 验证gh权限
          gh auth status
          # 验证文件存在
          if [ ! -f "${{ steps.package.outputs.final_bin }}" ] || [ ! -f "${{ steps.package.outputs.final_sum }}" ]; then
            echo "FATAL: Release files missing!"
            ls -lh release/
            exit 1
          fi
          # 创建Release
          gh release create ${{ steps.package.outputs.version }} \
            --title "Release ${{ steps.package.outputs.version }} (Static Binary)" \
            --generate-notes \
            --repo ${{ github.repository }} \
            ${{ steps.package.outputs.final_bin }} \
            ${{ steps.package.outputs.final_sum }}
          # 验证发布
          echo "✅ Release published successfully (no UPX compression)!"
          gh release view ${{ steps.package.outputs.version }} --repo ${{ github.repository }} --json assets --jq '.assets[].name'
