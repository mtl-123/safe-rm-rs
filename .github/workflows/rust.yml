name: Build & Release Static Binary

on:
  push:
    branches: [master]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

jobs:
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static Binary
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-musl
          components: rustfmt, clippy

      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends build-essential musl-tools upx-ucl gh
          musl-gcc --version || echo "musl-gcc ok"
          upx --version || echo "upx ok"
          rustup target add x86_64-unknown-linux-musl || echo "musl target ok"
          gh --version || echo "gh cli ok"

      - name: Build & Compress
        run: |
          set -euo pipefail
          BIN_NAME="srm"  # 保持与Cargo.toml一致的二进制名
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          # 静态编译
          RUSTFLAGS="-C target-cpu=native -C link-arg=-static -C linker=musl-gcc" \
          cargo build --release --target x86_64-unknown-linux-musl

          # 验证编译产物
          ls -lh target/x86_64-unknown-linux-musl/release/
          if [ ! -f "$BIN_PATH" ]; then echo "二进制文件缺失！"; exit 1; fi
          if ! file "$BIN_PATH" | grep -qi "statically linked"; then echo "非静态链接！"; exit 1; fi

          # UPX压缩（失败则回滚）
          cp "$BIN_PATH" "${BIN_PATH}.orig"
          upx --best --lzma "$BIN_PATH" || cp "${BIN_PATH}.orig" "$BIN_PATH"

      - name: Package (SRM命名)
        id: package
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="srm"

          # 仅Tag推送时处理发布包
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            # 核心修改：产物名改为srm开头
            FINAL_BIN="srm-${VERSION}-linux-x86_64-static"
            # 复制编译产物并重命名
            cp target/x86_64-unknown-linux-musl/release/${BIN_NAME} release/${FINAL_BIN}
            chmod +x release/${FINAL_BIN}
            # 生成校验和（文件名同步修改）
            sha256sum release/${FINAL_BIN} > release/${FINAL_BIN}.sha256

            # 输出到步骤变量，供后续使用
            echo "final_bin=release/${FINAL_BIN}" >> $GITHUB_OUTPUT
            echo "final_sum=release/${FINAL_BIN}.sha256" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT

            # 打印产物信息（日志可见）
            echo "=== 最终产物（SRM命名）==="
            ls -lh release/
            cat release/${FINAL_BIN}.sha256
          else
            echo "非Tag推送，跳过发布包处理"
          fi

      - name: Upload Artifact (SRM命名)
        uses: actions/upload-artifact@v4
        with:
          # Artifact名称同步改为srm开头
          name: ${{ startsWith(github.ref, 'refs/tags/') && format('srm-linux-x86_64-static-{0}', github.ref_name) || format('srm-linux-x86_64-static-dev-{0}', github.sha) }}
          path: release/
          retention-days: 30

      - name: Publish to GitHub Releases (SRM命名)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # 验证gh cli权限
          gh auth status
          # 验证产物存在
          if [ ! -f "${{ steps.package.outputs.final_bin }}" ] || [ ! -f "${{ steps.package.outputs.final_sum }}" ]; then
            echo "发布文件缺失！当前release目录内容："
            ls -lh release/
            exit 1
          fi
          # 创建Release（上传srm开头的文件）
          gh release create ${{ steps.package.outputs.version }} \
            --title "Release ${{ steps.package.outputs.version }} (Static Binary)" \
            --generate-notes \
            --repo ${{ github.repository }} \
            ${{ steps.package.outputs.final_bin }} \
            ${{ steps.package.outputs.final_sum }}
          # 验证发布结果
          echo "=== 发布成功！Releases文件列表 ==="
          gh release view ${{ steps.package.outputs.version }} --repo ${{ github.repository }} --json assets --jq '.assets[].name'
