name: Build & Release Static Binary

on:
  push:
    branches: [master]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

jobs:
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static Binary
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-musl
          components: rustfmt, clippy

      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends build-essential musl-tools upx-ucl
          musl-gcc --version || echo "musl-gcc ok"
          upx --version || echo "upx ok"
          rustup target add x86_64-unknown-linux-musl || echo "musl target ok"

      - name: Build & Compress
        run: |
          set -euo pipefail
          BIN_NAME="srm"  # 务必替换为你Cargo.toml中的实际二进制名
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          # 编译
          RUSTFLAGS="-C target-cpu=native -C link-arg=-static -C linker=musl-gcc" \
          cargo build --release --target x86_64-unknown-linux-musl

          # 验证产物
          ls -lh target/x86_64-unknown-linux-musl/release/
          if [ ! -f "$BIN_PATH" ]; then echo "Bin missing!"; exit 1; fi
          if ! file "$BIN_PATH" | grep -qi "statically linked"; then echo "Not static!"; exit 1; fi

          # UPX压缩
          cp "$BIN_PATH" "${BIN_PATH}.orig"
          upx --best --lzma "$BIN_PATH" || cp "${BIN_PATH}.orig" "$BIN_PATH"

      - name: Package
        id: package
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="srm"  # 同上，替换为实际二进制名

          # 定义版本号（强制用Tag名，仅Tag推送时执行）
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            FINAL_BIN="safe-rm-${VERSION}-linux-x86_64-static"
            # 复制产物
            cp target/x86_64-unknown-linux-musl/release/${BIN_NAME} release/${FINAL_BIN}
            chmod +x release/${FINAL_BIN}
            # 生成校验和
            sha256sum release/${FINAL_BIN} > release/${FINAL_BIN}.sha256
            # 输出关键信息到步骤输出
            echo "final_bin=release/${FINAL_BIN}" >> $GITHUB_OUTPUT
            echo "final_sum=release/${FINAL_BIN}.sha256" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            # 列出文件（日志可见）
            ls -lh release/
          else
            echo "Not a tag, skip package for release"
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: safe-rm-build-${{ github.sha }}
          path: release/
          retention-days: 30

      # 发布步骤：极致日志 + 强制验证
      - name: Publish to Releases
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # 安装gh cli（官方工具，比action更稳定）
          sudo apt install -y gh
          # 验证gh cli权限
          gh auth status
          # 验证产物存在
          if [ ! -f "${{ steps.package.outputs.final_bin }}" ] || [ ! -f "${{ steps.package.outputs.final_sum }}" ]; then
            echo "Release files missing!"
            ls -lh release/
            exit 1
          fi
          # 创建Release（gh cli方式，更稳定）
          gh release create ${{ steps.package.outputs.version }} \
            --title "Release ${{ steps.package.outputs.version }} (Static Binary)" \
            --generate-notes \
            --repo ${{ github.repository }} \
            ${{ steps.package.outputs.final_bin }} \
            ${{ steps.package.outputs.final_sum }}
          # 验证发布成功
          gh release view ${{ steps.package.outputs.version }} --repo ${{ github.repository }}
