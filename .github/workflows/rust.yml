name: Build & Release Binary

# 触发条件：master分支推送、Tag推送、手动触发
on:
  push:
    branches: [master]
    tags: ['v*']  # 匹配 v1.0.0、v1.1.0 等Tag
  workflow_dispatch:  # 手动触发

# 核心权限（必须，否则无法发布Releases）
permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-linux:
    name: Build Linux x86_64 Binary
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-gnu

      - name: Install System Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential upx  # 解决linker/UPX缺失问题

      - name: Build Optimized Binary
        run: |
          # 高性能编译（强制生成二进制）
          RUSTFLAGS="-C target-cpu=native" cargo build --release --target x86_64-unknown-linux-gnu
          # 验证二进制生成（失败则终止）
          ls -lh target/x86_64-unknown-linux-gnu/release/
          file target/x86_64-unknown-linux-gnu/release/safe-rm || exit 1
          # UPX压缩（失败不影响流程）
          upx --best --lzma target/x86_64-unknown-linux-gnu/release/safe-rm || echo "UPX压缩跳过"

      - name: Package Binary
        run: |
          mkdir -p release
          # ========== 修复点1：统一版本变量 ==========
          # Tag推送时用Tag名称，非Tag时用dev
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev-$(git rev-parse --short HEAD)"  # dev版本带提交哈希，更易识别
          fi
          # 复制二进制并命名（版本+架构）
          cp target/x86_64-unknown-linux-gnu/release/safe-rm release/safe-rm-v${VERSION}-linux-x86_64
          # 生成SHA256校验和
          sha256sum release/safe-rm-v${VERSION}-linux-x86_64 > release/safe-rm-v${VERSION}-linux-x86_64.sha256
          # 输出版本信息（便于日志排查）
          echo "最终打包版本：v${VERSION}"
          ls -lh release/

      - name: Upload Artifact（便于手动下载）
        uses: actions/upload-artifact@v4
        with:
          name: safe-rm-linux-x86_64
          path: release/

      # ========== 修复点2：统一文件路径变量 ==========
      # 仅Tag推送时发布到GitHub Releases
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          # 匹配打包后的文件名称（和Package Binary步骤一致）
          files: |
            release/safe-rm-v${{ github.ref_name }}-linux-x86_64
            release/safe-rm-v${{ github.ref_name }}-linux-x86_64.sha256
          # 自动生成发布说明
          generate_release_notes: true
          # 可选：标记为正式发布（非预发布）
          prerelease: false
          # 可选：发布标题（和Tag一致）
          name: "v${{ github.ref_name }}"