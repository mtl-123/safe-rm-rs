# 工作流名称
name: Build & Release Static Binary

# 触发条件：master分支推送、Tag推送（v开头）、手动触发
on:
  push:
    branches: [master]
    tags: ["v*"]
  workflow_dispatch:

# 核心权限配置（发布Releases必需）
permissions:
  contents: write
  packages: write
  actions: read

# 构建任务
jobs:
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static Binary
    runs-on: ubuntu-22.04
    steps:
      # 步骤1：拉取源码（取消浅克隆）
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 步骤2：安装Rust工具链
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-musl
          components: rustfmt, clippy

      # 步骤3：安装系统依赖（适配Ubuntu 22.04）
      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends \
            build-essential \
            musl-tools \
            upx-ucl
          # 验证依赖
          echo "=== 验证依赖版本 ==="
          musl-gcc --version || echo "musl-gcc 验证完成"
          upx --version || echo "upx 验证完成"
          rustup target add x86_64-unknown-linux-musl || echo "musl target 已安装"

      # 步骤4：静态编译二进制 + 安全的UPX压缩（修复link-type错误）
      - name: Build Static Optimized Binary & Safe UPX Compress
        run: |
          set -euo pipefail

          # 替换为你Cargo.toml中的实际二进制名（比如srm）
          BIN_NAME="srm"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          # 核心修复：移除错误的link-type参数，简化RUSTFLAGS
          echo "=== 开始静态编译 ==="
          RUSTFLAGS="\
            -C target-cpu=native \
            -C link-arg=-static \
            -C linker=musl-gcc" \
          cargo build --release --target x86_64-unknown-linux-musl

          # 调试：列出编译目录所有文件
          echo "=== 编译目录文件列表 ==="
          ls -lh target/x86_64-unknown-linux-musl/release/

          # 强制验证二进制生成
          echo "=== 验证编译产物 ==="
          if [ ! -f "$BIN_PATH" ]; then
            echo "错误：二进制文件未生成！编译目录内容："
            ls -la target/x86_64-unknown-linux-musl/release/
            exit 1
          fi

          # 强制验证静态链接
          echo "=== 验证静态链接 ==="
          if ! file "$BIN_PATH" | grep -qi "statically linked"; then
            echo "错误：二进制非静态链接！"
            file "$BIN_PATH"
            exit 1
          fi

          # 验证二进制可执行性（放宽条件）
          echo "=== 验证二进制可执行性 ==="
          chmod +x "$BIN_PATH"
          if ! "$BIN_PATH" --help > /dev/null 2>&1; then
            echo "警告：二进制--help执行失败，但继续流程"
          fi

          # 安全的UPX压缩（带降级+回滚）
          echo "=== UPX压缩二进制（安全模式） ==="
          cp "$BIN_PATH" "${BIN_PATH}.original"
          if upx --best --lzma "$BIN_PATH" > /dev/null 2>&1; then
            echo "✅ UPX高压缩级别成功"
          elif upx -6 "$BIN_PATH" > /dev/null 2>&1; then
            echo "⚠️ UPX高压缩失败，降级到-6级别成功"
          else
            echo "❌ UPX压缩失败，使用原始二进制"
            cp "${BIN_PATH}.original" "$BIN_PATH"
          fi

      # 步骤5：打包二进制+生成校验和
      - name: Package Binary & Generate Checksum
        run: |
          set -euo pipefail
          mkdir -p release

          # 统一二进制名
          BIN_NAME="srm"
          # 版本号处理
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            SHORT_SHA=$(git rev-parse --short HEAD)
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            VERSION="dev-${SHORT_SHA}-${TIMESTAMP}"
          fi

          # 产物命名
          FINAL_BIN_NAME="safe-rm-${VERSION}-linux-x86_64-static"
          cp target/x86_64-unknown-linux-musl/release/${BIN_NAME} release/${FINAL_BIN_NAME}
          chmod +x release/${FINAL_BIN_NAME}

          # 生成SHA256校验和
          sha256sum release/${FINAL_BIN_NAME} | awk '{print $1 "  " $2}' > release/${FINAL_BIN_NAME}.sha256

          # 输出结果
          echo "=== 最终打包文件 ==="
          ls -lh release/
          cat release/${FINAL_BIN_NAME}.sha256

      # 步骤6：上传Artifact
      - name: Upload Binary to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ startsWith(github.ref, 'refs/tags/') && format('safe-rm-linux-x86_64-static-{0}', github.ref_name) || format('safe-rm-linux-x86_64-static-dev-{0}', github.sha) }}
          path: release/
          retention-days: 30

      # 步骤7：发布到GitHub Releases
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/safe-rm-${{ github.ref_name }}-linux-x86_64-static
            release/safe-rm-${{ github.ref_name }}-linux-x86_64-static.sha256
          generate_release_notes: true
          prerelease: false
          name: "Release ${{ github.ref_name }} (Static Binary)"
