# 工作流名称
name: Build & Release Static Binary

# 触发条件：master分支推送、Tag推送（v开头）、手动触发
on:
  push:
    branches: [master]
    tags: ["v*"]
  workflow_dispatch:

# 核心权限配置（发布Releases必需）
permissions:
  contents: write
  packages: write
  actions: read

# 构建任务
jobs:
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static Binary
    runs-on: ubuntu-22.04
    steps:
      # 步骤1：拉取源码
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：安装Rust工具链（含musl静态编译目标）
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-musl # 静态编译目标
          components: rustfmt, clippy

      # 步骤3：安装系统依赖（静态编译 + UPX压缩必需）
      - name: Install System Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential musl-tools upx
          musl-gcc --version
          upx --version

      # 步骤4：静态编译二进制 + UPX压缩（核心整合）
      - name: Build Static Optimized Binary & UPX Compress
        run: |
          # 静态编译命令：启用CPU原生优化+静态链接+发布模式
          RUSTFLAGS="-C target-cpu=native -C link-arg=-static" \
          cargo build --release --target x86_64-unknown-linux-musl

          # 强制验证二进制生成（✅ 修正为 srm）
          echo "=== 验证编译产物 ==="
          ls -lh target/x86_64-unknown-linux-musl/release/
          if [ ! -f "target/x86_64-unknown-linux-musl/release/srm" ]; then
            echo "错误：二进制文件未生成！"
            exit 1
          fi

          # 验证静态链接
          file target/x86_64-unknown-linux-musl/release/srm

          # UPX压缩（✅ 修正为 srm）
          echo "=== UPX压缩二进制 ==="
          upx --best --lzma target/x86_64-unknown-linux-musl/release/srm
          chmod +x target/x86_64-unknown-linux-musl/release/srm
          ./target/x86_64-unknown-linux-musl/release/srm --help || echo "UPX压缩后功能验证（非强制）"

      # 步骤5：打包二进制+生成校验和
      - name: Package Binary & Generate Checksum
        run: |
          mkdir -p release

          # 版本号处理
          VERSION="${{ github.ref_name }}"
          if [[ "${{ github.ref }}" != refs/tags/* ]]; then
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi

          # 复制并命名静态二进制（✅ 修正为 srm）
          BIN_NAME="srm-${VERSION}-linux-x86_64-static"
          cp target/x86_64-unknown-linux-musl/release/srm release/${BIN_NAME}

          # 生成SHA256校验和
          sha256sum release/${BIN_NAME} > release/${BIN_NAME}.sha256

          echo "=== 最终打包文件 ==="
          ls -lh release/
          cat release/${BIN_NAME}.sha256

      # 步骤6：上传Artifact
      - name: Upload Binary to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: srm-linux-x86_64-static-${{ github.ref_name }}
          path: release/
          retention-days: 30

      # 步骤7：发布到GitHub Releases（仅Tag推送）
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/srm-${{ github.ref_name }}-linux-x86_64-static
            release/srm-${{ github.ref_name }}-linux-x86_64-static.sha256
          generate_release_notes: true
          prerelease: false
          name: "Release ${{ github.ref_name }} (Static Binary)"
          tag_name: ${{ github.ref_name }}
