# 工作流名称
name: Build & Release Static Binary

# 触发条件：master分支推送、Tag推送（v开头）、手动触发
on:
  push:
    branches: [master]
    tags: ["v*"]
  workflow_dispatch:

# 核心权限配置（加固：增加id-token: write，适配新版GitHub API）
permissions:
  contents: write
  packages: write
  actions: read
  id-token: write  # 新增：解决部分场景下的权限问题

# 构建任务
jobs:
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static Binary
    runs-on: ubuntu-22.04
    steps:
      # 步骤1：拉取源码
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 步骤2：安装Rust工具链
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-musl
          components: rustfmt, clippy

      # 步骤3：安装系统依赖
      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends \
            build-essential \
            musl-tools \
            upx-ucl
          musl-gcc --version || echo "musl-gcc 验证完成"
          upx --version || echo "upx 验证完成"
          rustup target add x86_64-unknown-linux-musl || echo "musl target 已安装"

      # 步骤4：静态编译+UPX压缩（不变）
      - name: Build Static Optimized Binary & Safe UPX Compress
        run: |
          set -euo pipefail
          BIN_NAME="srm"  # 替换为你的实际二进制名
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          RUSTFLAGS="\
            -C target-cpu=native \
            -C link-arg=-static \
            -C linker=musl-gcc" \
          cargo build --release --target x86_64-unknown-linux-musl

          echo "=== 编译目录文件列表 ==="
          ls -lh target/x86_64-unknown-linux-musl/release/

          if [ ! -f "$BIN_PATH" ]; then
            echo "错误：二进制文件未生成！"
            ls -la target/x86_64-unknown-linux-musl/release/
            exit 1
          fi

          if ! file "$BIN_PATH" | grep -qi "statically linked"; then
            echo "错误：二进制非静态链接！"
            file "$BIN_PATH"
            exit 1
          fi

          chmod +x "$BIN_PATH"
          if ! "$BIN_PATH" --help > /dev/null 2>&1; then
            echo "警告：二进制--help执行失败，但继续流程"
          fi

          cp "$BIN_PATH" "${BIN_PATH}.original"
          if upx --best --lzma "$BIN_PATH" > /dev/null 2>&1; then
            echo "✅ UPX高压缩级别成功"
          elif upx -6 "$BIN_PATH" > /dev/null 2>&1; then
            echo "⚠️ UPX高压缩失败，降级到-6级别成功"
          else
            echo "❌ UPX压缩失败，使用原始二进制"
            cp "${BIN_PATH}.original" "$BIN_PATH"
          fi

      # 步骤5：打包+校验和（不变）
      - name: Package Binary & Generate Checksum
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="srm"  # 替换为你的实际二进制名

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            SHORT_SHA=$(git rev-parse --short HEAD)
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            VERSION="dev-${SHORT_SHA}-${TIMESTAMP}"
          fi

          FINAL_BIN_NAME="safe-rm-${VERSION}-linux-x86_64-static"
          cp target/x86_64-unknown-linux-musl/release/${BIN_NAME} release/${FINAL_BIN_NAME}
          chmod +x release/${FINAL_BIN_NAME}
          sha256sum release/${FINAL_BIN_NAME} | awk '{print $1 "  " $2}' > release/${FINAL_BIN_NAME}.sha256

          echo "=== 最终打包文件 ==="
          ls -lh release/
          cat release/${FINAL_BIN_NAME}.sha256

          # 新增：输出产物路径，便于发布步骤校验
          echo "FINAL_BIN_PATH=release/${FINAL_BIN_NAME}" >> $GITHUB_ENV
          echo "FINAL_CHECKSUM_PATH=release/${FINAL_BIN_NAME}.sha256" >> $GITHUB_ENV

      # 步骤6：上传Artifact（不变）
      - name: Upload Binary to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ startsWith(github.ref, 'refs/tags/') && format('safe-rm-linux-x86_64-static-{0}', github.ref_name) || format('safe-rm-linux-x86_64-static-dev-{0}', github.sha) }}
          path: release/
          retention-days: 30

      # 步骤7：发布到GitHub Releases（核心优化）
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        env:
          # 显式指定GITHUB_TOKEN（解决隐性权限问题）
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # 使用环境变量引用产物路径，避免硬编码错误
          files: |
            ${{ env.FINAL_BIN_PATH }}
            ${{ env.FINAL_CHECKSUM_PATH }}
          generate_release_notes: true
          prerelease: false
          name: "Release ${{ github.ref_name }} (Static Binary)"
          # 新增：允许覆盖同名Release（解决Tag重复发布问题）
          overwrite: true
        # 新增：捕获发布错误，输出详细日志
        continue-on-error: false
