# `srm` — Safe Alternative to `rm`

> **安全删除，永不误删**  
> 一个高性能、跨平台（Linux/macOS）、可中断、带恢复功能的 `rm` 替代工具。

---

## 📌 目录

- [1. 概述](#1-概述)
- [2. 功能特性](#2-功能特性)
- [3. 开发与运行环境](#3-开发与运行环境)
- [4. 安装](#4-安装)
- [5. 命令详解](#5-命令详解)
  - [`srm del` — 安全删除](#srm-del--安全删除)
  - [`srm res` — 恢复文件](#srm-res--恢复文件)
  - [`srm ls` — 列出回收站](#srm-ls--列出回收站)
  - [`srm cln` — 清理过期文件](#srm-cln--清理过期文件)
  - [`srm empty` — 清空回收站](#srm-empty--清空回收站)
- [6. 高性能构建](#6-高性能构建)
- [7. 日志与审计](#7-日志与审计)
- [8. 故障排查](#8-故障排查)
- [9. 安全说明](#9-安全说明)
- [10. 许可证](#10-许可证)

---

## 1. 概述

`srm`（Safe Remove）是一个 **安全替代系统 `rm` 命令** 的工具。它不会真正删除文件，而是将文件移动到用户专属的回收站目录（`~/.srm/trash`），并记录元数据，支持后续恢复、清理和审计。

**核心理念**：  
> “删除” ≠ “永久丢失”，而是“暂时移入安全区”。

适用于：
- 开发者日常文件管理
- 运维人员批量操作
- 自动化脚本中的安全删除

---

## 2. 功能特性

✅ **安全删除**  
- 移动而非删除，避免误操作  
- 支持文件、目录、符号链接  

✅ **完整恢复**  
- 恢复到原始路径或自定义路径  
- 覆盖前交互式确认（可强制跳过）  

✅ **中断保护**  
- 删除过程中按 `Ctrl+C` → 自动回滚已移动的文件  

✅ **智能保护**  
- 默认阻止删除 `/bin`, `/etc`, `/usr` 等系统目录（需 `-f` 强制）  

✅ **自动清理**  
- 文件默认 7 天后过期，可自定义  
- 手动清理过期或全部文件  

✅ **结构化日志**  
- JSONL 格式日志，保留 30 天  
- 记录操作、路径、时间、结果  

✅ **高性能**  
- 优先使用 `rename()`（原子操作，零拷贝）  
- 跨文件系统时 fallback 到高效复制  

✅ **用户体验**  
- 每个子命令含详细帮助和使用示例  
- 参数错误时提示正确用法  

---

## 3. 开发与运行环境

### ✅ 支持平台
- **Linux**（Debian, Ubuntu, CentOS, AlmaLinux 等）
- **macOS**（Intel / Apple Silicon）

> ❌ 不支持 Windows

### ✅ 系统要求
- POSIX 兼容文件系统（ext4, XFS, APFS, ZFS 等）
- 支持符号链接和 Unix 权限

### ✅ Rust 版本
- **Rust 1.70+**（推荐使用 `rustup` 管理）
- 测试通过版本：`rustc 1.78.0`, `1.80.0`

### ✅ 依赖工具
| 工具 | 用途 | 安装方式 |
|------|------|--------|
| `cargo` | 构建工具 | `curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh` |
| `clippy` | 代码检查 | `rustup component add clippy` |
| `jq` | 日志分析（可选） | `sudo apt install jq` |

### ✅ 开发依赖（`Cargo.toml`）
```toml
clap = "4.5"        # 命令行解析
chrono = "0.4"      # 时间处理
dirs = "5.0"        # 路径获取
serde = "1.0"       # 序列化
serde_json = "1.0"  # JSON 处理
ctrlc = "3.4"       # 中断信号处理
```

---

## 4. 安装

### 方法 1：从源码构建（推荐）

```bash
# 克隆仓库
git clone https://github.com/yourname/srm.git
cd srm

# 构建（启用高性能优化）
cargo build --release

# 安装到系统路径
sudo cp target/release/srm /usr/local/bin/

# 验证
srm --version
```

### 方法 2：直接下载二进制（未来支持）

> 当前仅支持源码构建。

---

## 5. 命令详解

### `srm del` — 安全删除

**功能**：将文件/目录移动到 `~/.srm/trash`，不真正删除。

**语法**：
```bash
srm del [OPTIONS] <PATHS>...
```

**选项**：
| 选项 | 说明 | 默认值 |
|------|------|-------|
| `-d, --expire-days <DAYS>` | 设置过期天数 | `7` |
| `-f, --force` | 强制删除受保护路径 | 无 |

**使用示例**：
```bash
# 删除单个文件
srm del report.pdf

# 删除多个文件/目录
srm del file1.txt dir1/ project/

# 设置 30 天后过期
srm del -d 30 important.log

# 强制删除受保护路径（谨慎！）
srm del -f /tmp/protected-dir
```

**保护机制**：  
默认阻止删除以下路径（除非使用 `-f`）：
- `/bin`, `/sbin`, `/etc`, `/usr`, `/lib`, `/lib64`, `/root`, `/boot`

> 💡 提示：`/home/user/bin` 不受影响，仅根目录下的系统路径被保护。

---

### `srm res` — 恢复文件

**功能**：从回收站恢复文件到原始路径或自定义路径。

**语法**：
```bash
srm res [OPTIONS] <NAMES>...
```

**选项**：
| 选项 | 说明 |
|------|------|
| `-f, --force` | 强制覆盖目标路径（跳过确认） |
| `-t, --target <PATH>` | 恢复到自定义路径 |

**使用示例**：
```bash
# 列出回收站，获取垃圾名
srm ls

# 恢复到原始路径（交互式确认）
srm res file.txt_1735689000000000000

# 恢复到自定义目录
srm res docs_1735... -t ~/recovered/

# 恢复并重命名为新文件
srm res file.txt_1735... -t ~/backup/new_name.txt

# 强制覆盖（无提示）
srm res file.txt_1735... -f
```

**覆盖行为**：
- 若目标存在，**默认提示 `[y/N]`**
- 使用 `-f` 跳过提示，直接覆盖
- 恢复后尝试还原原始权限（mode/uid/gid）

---

### `srm ls` — 列出回收站

**功能**：显示回收站中所有文件及其状态。

**语法**：
```bash
srm ls [OPTIONS]
```

**选项**：
| 选项 | 说明 |
|------|------|
| `--expired` | 仅显示已过期项 |

**输出格式**：
```
<垃圾名>: <原始路径> (<状态>)
```
- 状态：`Active`（未过期）或 `Expired`（已过期）

**使用示例**：
```bash
# 列出所有
srm ls

# 仅列出过期文件
srm ls --expired
```

---

### `srm cln` — 清理过期文件

**功能**：删除回收站中已过期的文件。

**语法**：
```bash
srm cln [OPTIONS]
```

**选项**：
| 选项 | 说明 |
|------|------|
| `-a, --all` | 清理所有文件（忽略过期状态） |

**使用示例**：
```bash
# 清理过期文件（默认）
srm cln

# 清空整个回收站（危险！）
srm cln -a
```

> ⚠️ 注意：`srm cln -a` 不可逆，请谨慎使用。

---

### `srm empty` — 清空回收站

**功能**：永久删除回收站中**所有**文件（不可恢复）。

**语法**：
```bash
srm empty [OPTIONS]
```

**选项**：
| 选项 | 说明 |
|------|------|
| `-y, --yes` | 跳过确认提示 |

**使用示例**：
```bash
# 交互式确认
srm empty

# 直接清空（无提示）
srm empty -y
```

> 🔒 安全设计：默认要求用户确认，防止误操作。

---

## 6. 高性能构建

`srm` 使用 Rust 的极致优化配置，确保最小体积和最高性能。

### 编译配置（`Cargo.toml`）
```toml
[profile.release]
opt-level = 3        # 最高优化级别
lto = "fat"          # 全程序优化
codegen-units = 1    # 单代码生成单元（提升优化效果）
panic = "abort"      # 减小体积（不展开 panic 信息）
strip = true         # 移除调试符号
```

### 构建命令
```bash
cargo build --release
```

### 性能优势
| 指标 | 说明 |
|------|------|
| **二进制大小** | ~500 KB（strip 后） |
| **启动速度** | < 5ms |
| **大文件处理** | 优先 `rename()`（零拷贝），跨设备时高效流式复制 |
| **内存占用** | 常驻内存 < 5 MB |

---

## 7. 日志与审计

### 日志位置
```
~/.srm/srm.log
```

### 日志格式（JSONL）
每行一个 JSON 对象：
```json
{
  "timestamp": "2026-01-26 18:30:45.123",
  "level": "INFO",
  "message": "Successfully moved to trash",
  "details": {
    "original_path": "/home/user/report.pdf",
    "trash_name": "report.pdf_1735689045123456789"
  }
}
```

### 日志保留策略
- **自动轮转**：每次启动时清理 >30 天的日志
- **手动分析**：
  ```bash
  # 查看所有删除操作
  jq -r 'select(.message | contains("moved"))' ~/.srm/srm.log

  # 查看错误
  jq -r 'select(.level=="ERROR")' ~/.srm/srm.log
  ```

---

## 8. 故障排查

### 常见问题

| 问题 | 解决方案 |
|------|--------|
| `srm: command not found` | 确保 `srm` 在 `$PATH` 中（如 `/usr/local/bin/`） |
| 权限恢复失败 | 恢复非自己拥有的文件需 `sudo` |
| 符号链接失效 | 相对符号链接在恢复到不同目录时可能失效（正常行为） |
| 回收站空间不足 | 确保 `$HOME` 有足够空间（删除操作会先复制） |

### 调试命令
```bash
# 查看回收站结构
ls -la ~/.srm/

# 查看元数据
cat ~/.srm/meta/*.meta

# 实时监控日志
tail -f ~/.srm/srm.log | jq .
```

---

## 9. 安全说明

- **无网络请求**：`srm` 完全离线运行，不收集任何数据。
- **最小权限**：仅访问用户家目录，无需 root 权限。
- **原子操作**：优先使用 `rename()`，避免中间状态。
- **中断安全**：`Ctrl+C` 触发回滚，保证数据一致性。
- **系统保护**：默认阻止危险路径删除。

> 🔐 设计原则：**安全第一，性能第二**。

---

## 10. 许可证

MIT License

Copyright (c) 2026 Your Name

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

---

> ✨ **让删除不再可怕 —— `srm` 为您的数据保驾护航**